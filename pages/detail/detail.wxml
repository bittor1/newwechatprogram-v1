<view class="container">
  <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
  <view class="profile-card card p-16">
    <view class="profile-avatar-container">
      <image class="profile-avatar" src="{{entryInfo.avatarUrl || entryInfo.avatar || '/images/placeholder-user.jpg'}}" mode="aspectFill" lazy-load="true"></image>
      <view class="rank-tag">#{{entryInfo.rank}}</view>
    </view>
    
    <text class="profile-name h2">{{entryInfo.name}}</text>
    <text class="profile-title text-body">ä¼¦æ•¦å¾—åƒç‹è€…</text>
    
    <view class="badge-row flex justify-center gap-12 my-16">
      <!-- æ ‡ç­¾1: æ’å/æˆå°± -->
      <!-- å€’æ•°ä¸‰åä¼˜å…ˆï¼šåƒäº†èƒƒç–¼ (totalEntries >= 3 ä¸” rank > totalEntries - 3) -->
      <view class="badge badge-gray" wx:if="{{totalEntries >= 3 && entryInfo.rank > totalEntries - 3}}">ğŸ¤¢ åƒäº†èƒƒç–¼</view>
      <!-- æƒ³åƒæ•°ä¸ºè´Ÿæ•°ï¼ˆéå€’æ•°ä¸‰åï¼‰ -->
      <view class="badge badge-gray" wx:elif="{{entryInfo.votes < 0}}">ğŸ‘ ä¸è±ªèµ¤</view>
      <!-- æ­£å¸¸æ’åæ ‡ç­¾ -->
      <view class="badge badge-red" wx:elif="{{entryInfo.rank === 1}}">ğŸ‘ æ­¤ä¹ƒå·¨å„’</view>
      <view class="badge badge-orange" wx:elif="{{entryInfo.rank <= 3}}">ğŸ‘ æ­¤ä¹ƒè‹±ç²¾</view>
      <view class="badge badge-yellow" wx:elif="{{entryInfo.rank <= 10}}">ğŸ‘ å¤§è‹±å¸</view>
      <view class="badge badge-purple" wx:elif="{{entryInfo.votes >= 100}}">ğŸ‘ è±ªèµ¤</view>
      <view class="badge badge-blue" wx:else>ğŸ‘ è±ªèµ¤</view>
      
      <!-- æ ‡ç­¾2: è¶‹åŠ¿/çŠ¶æ€ -->
      <view class="badge badge-green" wx:if="{{entryInfo.trend === 'up'}}">ğŸš€ æ’é˜Ÿå¾—åƒ</view>
      <view class="badge badge-blue" wx:elif="{{entryInfo.trend === 'stable'}}">ğŸ›¡ï¸ ç¨³å®šå‘æŒ¥</view>
      <view class="badge badge-red" wx:elif="{{entryInfo.trend === 'down'}}">ğŸ’” æ²¡æœ‰è¡Œæƒ…</view>
      <view class="badge badge-gray" wx:else>âœ¨ æœŸå¾…çˆ†å‘</view>
    </view>
    
    <view class="points-display flex justify-center items-center">
      <text class="points-number">{{entryInfo.votes}}</text>
      <text class="points-label text-body">äººæƒ³åƒ</text>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’®ç»„ -->
  <view class="action-buttons card p-16">
    <button class="action-btn btn btn-accent-green" bindtap="handleVote">
      <text class="btn-icon">ğŸ‘</text>
      <text class="btn-text">æƒ³åƒ</text>
    </button>
    <button class="action-btn btn btn-secondary" bindtap="handleDownVote">
      <text class="btn-icon">âœ‹</text>
      <text class="btn-text">æ‹’åƒ</text>
    </button>
    <button class="action-btn btn btn-secondary" open-type="share">
      <text class="btn-icon">ğŸ‘†</text>
      <text class="btn-text">ç»™æœ‹å‹åƒ</text>
    </button>
  </view>

  <!-- éŸ³æ•ˆåŠŸèƒ½åŒº -->
  <view class="sound-section card p-16">
    <view class="custom-flex-row">
      <!-- å½•åˆ¶æŠ•ç¥¨éŸ³æ•ˆæŒ‰é’® / å½•éŸ³è¿›åº¦æ¡ / é¢„è§ˆéŸ³æ•ˆæŒ‰é’® -->
      <view class="custom-flex-large">
        <!-- åˆå§‹çŠ¶æ€ï¼šå½•åˆ¶æŠ•ç¥¨éŸ³æ•ˆæŒ‰é’® -->
        <button wx:if="{{recordingState === 'idle'}}" 
                class="sound-btn btn btn-accent-purple" 
                bindtap="recordSound" style="width: 356rpx; display: flex; box-sizing: border-box; left: -4rpx; top: 0rpx; position: relative">
          <text class="btn-icon">ğŸ¤</text>
          <text class="btn-text">å½•åˆ¶æŠ•ç¥¨éŸ³æ•ˆ</text>
        </button>
        
        <!-- å½•åˆ¶ä¸­çŠ¶æ€ï¼šå½•éŸ³è¿›åº¦æ¡ -->
        <view wx:if="{{recordingState === 'recording'}}" class="recording-progress">
          <view class="progress-container">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{(recordTime/5)*100}}%"></view>
            </view>
            <text class="progress-time">{{formattedRecordTime}} / 00:05</text>
          </view>
          <view class="recording-indicator">
            <text class="recording-dot">â—</text>
            <text class="recording-text">å½•éŸ³ä¸­...</text>
          </view>
        </view>
        
        <!-- å½•åˆ¶å®ŒæˆçŠ¶æ€ï¼šé¢„è§ˆéŸ³æ•ˆæŒ‰é’® -->
        <view wx:if="{{recordingState === 'recorded'}}" class="preview-sound-container">
          <button class="preview-sound-btn btn btn-accent-blue" bindtap="previewRecordedSound">
            <view class="preview-content">
              <text class="btn-icon">ğŸ”Š</text>
              <text class="btn-text">é¢„è§ˆéŸ³æ•ˆ ({{formattedTempDuration}}s)</text>
            </view>
            <text class="delete-icon" catchtap="deleteRecordedSound">ğŸ—‘</text>
          </button>
        </view>
      </view>
      
      <!-- ç¡®è®¤éŸ³æ•ˆæŒ‰é’® / ç¡®è®¤+å–æ¶ˆæŒ‰é’® -->
      <view class="custom-flex-small">
        <!-- åˆå§‹çŠ¶æ€å’Œå½•åˆ¶å®ŒæˆçŠ¶æ€ï¼šç¡®è®¤éŸ³æ•ˆæŒ‰é’® -->
        <button wx:if="{{recordingState === 'idle' || recordingState === 'recorded'}}" 
                class="record-btn btn btn-secondary" 
                bindtap="recordSound">
          <text class="btn-icon">âœ“</text>
          <text class="btn-text">ç¡®è®¤éŸ³æ•ˆ</text>
        </button>
        
        <!-- å½•åˆ¶ä¸­çŠ¶æ€ï¼šç¡®è®¤+å–æ¶ˆæŒ‰é’® -->
        <view wx:if="{{recordingState === 'recording'}}" class="recording-actions">
          <button class="confirm-record-btn btn btn-accent-green" bindtap="confirmRecording">
            <text class="btn-text">ç¡®è®¤</text>
          </button>
          <button class="cancel-record-btn btn btn-secondary" bindtap="cancelRecording">
            <text class="btn-text">å–æ¶ˆ</text>
          </button>
        </view>
      </view>
    </view>
    
    <!-- å½“å‰é¡µé¢éŸ³æ•ˆæç¤º -->
    <view wx:if="{{currentPageSound}}" class="current-sound-tip">
      <text class="tip-text">å½“å‰éŸ³æ•ˆï¼š{{currentPageSound.name || 'æŠ•ç¥¨éŸ³æ•ˆ'}}</text>
    </view>
  </view>

  <!-- å¼¹å¹•è¾“å…¥åŒº -->
  <view class="danmaku-input-section card p-16">
    <view class="custom-flex-row">
      <input 
        class="danmaku-input input custom-flex-large"
        placeholder="å‘ä¸ªå¼¹å¹•è°ƒä¾ƒä¸€ä¸‹..." 
        value="{{danmakuText}}" 
        bindinput="onDanmakuInput"
      />
      <button class="action-btn btn btn-accent-purple custom-flex-small" bindtap="sendDanmaku">
        <text class="btn-icon">âœˆï¸</text>
        <text class="btn-text">å‘é€</text>
      </button>
    </view>
  </view>

  <!-- æˆ˜ç»©å¢™ -->
  <view class="achievements-section card p-16 mb-16">
    <view class="section-header flex items-center mb-16">
      <text class="section-icon">ğŸ†</text>
      <text class="section-title h2">æˆ˜ç»©å¢™</text>
    </view>
    
    <view class="achievements-list">
      <view class="achievement-item {{item.type === 'success' ? 'success' : item.type === 'fail' ? 'fail' : 'neutral'}}" 
        wx:for="{{achievements}}" 
        wx:key="_id"
      >
        <view class="achievement-content">
          <text class="achievement-username">{{item.creatorName || 'åŒ¿åç”¨æˆ·'}}</text>
          <text class="achievement-separator">ï¼š</text>
          <text class="achievement-text text-body">{{item.content}}</text>
        </view>
      </view>
      
      <button class="add-achievement-btn" bindtap="addAchievement">
        <text class="add-icon">â•</text>
        <text class="add-text text-body">çˆ†æ–™æ–°äº‹è¿¹</text>
      </button>
    </view>
  </view>
  
  <!-- è¯„è®ºåŒº -->
  <view class="comments-section card p-16 mb-16">
    <view class="section-header flex items-center mb-16">
      <text class="section-icon">ğŸ’¬</text>
      <text class="section-title h2">è¯„è®ºåŒº ({{commentCount || 0}})</text>
    </view>
    
    <!-- è¯„è®ºè¾“å…¥æ¡† -->
    <view class="comment-input-container mb-16">
      <view class="comment-input-wrapper">
        <input 
          class="comment-input input" 
          placeholder="{{replyTo ? 'å›å¤ ' + replyTo.creatorName : 'æ·»åŠ è¯„è®º...'}}"
          value="{{commentContent}}"
          bindinput="onCommentInput"
          adjust-position="{{false}}"
          hold-keyboard="{{true}}"
          confirm-type="send"
          bindconfirm="submitComment"
        />
        <!-- å–æ¶ˆå›å¤æŒ‰é’® -->
        <view wx:if="{{replyTo}}" class="cancel-reply-btn" bindtap="cancelReply">
          <text>Ã—</text>
        </view>
      </view>
      <button class="comment-submit-btn btn btn-accent-purple" bindtap="submitComment">
        <text class="btn-text">å‘é€</text>
      </button>
    </view>
    
    <!-- è¯„è®ºåˆ—è¡¨ -->
    <view class="comments-list">
      <block wx:if="{{comments.length > 0}}">
        <!-- é¡¶çº§è¯„è®º -->
        <view class="comment-item" wx:for="{{comments}}" wx:key="_id">
          <view class="comment-main">
            <image class="comment-avatar" src="{{item.creatorAvatar}}" mode="aspectFill"></image>
            <view class="comment-body">
              <view class="comment-header">
                <text class="comment-username">{{item.creatorName}}</text>
              </view>
              <text class="comment-content">{{item.content}}</text>
              <text class="comment-time">{{formatTime(item.createTime)}}</text>
              <view class="comment-actions">
                <text class="action-item" bindtap="replyComment" data-id="{{item._id}}" data-name="{{item.creatorName}}">
                  <text class="action-text">å›å¤</text>
                </text>
                <text class="action-item" bindtap="likeComment" data-id="{{item._id}}">
                  <text class="action-text">èµ{{item.likes > 0 ? ' ' + item.likes : ''}}</text>
                </text>
                <text wx:if="{{item._openid && currentUser.openid && item._openid === currentUser.openid}}" class="action-item delete-action" bindtap="deleteComment" data-id="{{item._id}}" data-type="comment">
                  <text class="action-text">åˆ é™¤</text>
                </text>
              </view>
            </view>
          </view>
          
          <!-- å­è¯„è®ºåˆ—è¡¨ -->
          <view class="replies-container" wx:if="{{item.replies && item.replies.length > 0}}">
            <block wx:for="{{item.replies}}" wx:for-item="reply" wx:key="_id">
              <view class="reply-item">
                <view class="reply-main">
                  <image class="reply-avatar" src="{{reply.creatorAvatar}}" mode="aspectFill"></image>
                  <view class="reply-body">
                    <view class="reply-header">
                      <text class="reply-username">{{reply.creatorName}}</text>
                      <text class="reply-to" wx:if="{{reply.replyTo && reply.replyTo.userName}}">å›å¤{{reply.replyTo.userName}}:</text>
                    </view>
                    <text class="reply-content">{{reply.content}}</text>
                    <text class="reply-time">{{formatTime(reply.createTime)}}</text>
                    <view class="reply-actions">
                      <text class="reply-action-item" bindtap="replyComment" data-id="{{reply._id}}" data-name="{{reply.creatorName}}">å›å¤</text>
                      <text class="reply-action-item" bindtap="likeComment" data-id="{{reply._id}}">èµ{{reply.likes > 0 ? ' ' + reply.likes : ''}}</text>
                      <text wx:if="{{reply._openid && currentUser.openid && reply._openid === currentUser.openid}}" class="reply-action-item delete-action" bindtap="deleteComment" data-id="{{reply._id}}" data-type="reply">åˆ é™¤</text>
                    </view>
                  </view>
                </view>
              </view>
            </block>
            
            <!-- æŸ¥çœ‹æ›´å¤šå›å¤ -->
            <view class="view-more-replies" wx:if="{{item.replyCount > 3 && !showingMoreReplies[item._id]}}" bindtap="showMoreReplies" data-id="{{item._id}}">
              æŸ¥çœ‹å…¨éƒ¨ {{item.replyCount}} æ¡å›å¤
            </view>
          </view>
        </view>
      </block>
      
      <!-- åŠ è½½æ›´å¤šè¯„è®º -->
      <view class="load-more" bindtap="loadMoreComments" wx:if="{{hasMoreComments}}">
        åŠ è½½æ›´å¤šè¯„è®º...
      </view>
      
      <!-- æš‚æ— è¯„è®º -->
      <view class="empty-comments" wx:if="{{comments.length === 0}}">
        æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼
      </view>
    </view>
  </view>

  <!-- åˆ›å»ºä¸€ä¸ªwxsæ¨¡å—æ¥ç”Ÿæˆå¼¹å¹•æ ·å¼ -->
  <wxs module="danmakuStyle">
    function getStyle(top, duration) {
      return "top:" + top + "%; animation-duration:" + duration + "ms; animation-name:danmaku;";
    }
    module.exports = {
      getStyle: getStyle
    };
  </wxs>

  <!-- å¼¹å¹•å±‚ -->
  <view class="danmaku-layer">
    <view 
      class="danmaku-item" 
      wx:for="{{danmakuList}}" 
      wx:key="id"
      style="{{danmakuStyle.getStyle(item.top, item.duration)}}"
    >
      {{item.text}}
    </view>
  </view>
  
  <!-- å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{modalType !== ''}}" bindtap="closeModal">
    <view class="modal-content card" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title h2">{{modalTitle}}</text>
      </view>
      
      <view class="modal-body p-16">
        <!-- äº‹è¿¹å¼¹çª— -->
        <view wx:if="{{modalType === 'achievement'}}" class="achievement-modal flex flex-col gap-16">
          <textarea 
            class="achievement-textarea" 
            placeholder="è¯´è¯´TAçš„ç²¾å½©äº‹è¿¹..." 
            value="{{newAchievement}}"
            bindinput="onAchievementInput"
          ></textarea>
          <button 
            class="modal-btn btn btn-primary" 
            bindtap="submitAchievement"
            disabled="{{!newAchievement}}"
          >
            æ·»åŠ äº‹è¿¹
          </button>
        </view>
      </view>
    </view>
  </view>
  
  <!-- åˆ†äº«å¥–åŠ±å¼¹çª— -->
  <view class="share-modal-overlay" wx:if="{{showShareModal}}" bindtap="closeShareModal">
    <view class="share-modal-content" catchtap="">
      <view class="share-modal-header">
        <text class="share-modal-title">é€šè¿‡åˆ†äº«è·å¾—æ›´å¤šå¥–åŠ±</text>
      </view>
      
      <view class="share-modal-body">
        <text class="share-modal-text">æ‚¨ä»Šæ—¥å·²{{shareModalType === 'vote' ? 'æƒ³åƒ' : 'æ‹’åƒ'}}è¿‡ï¼Œåˆ†äº«ç»™æœ‹å‹å¯å†æ¬¡è·å¾—å¥–åŠ±ï¼</text>
        <text class="share-modal-progress">ä»Šæ—¥{{shareModalType === 'vote' ? 'æƒ³åƒ' : 'æ‹’åƒ'}}å¥–åŠ±æ¬¡æ•°ï¼š{{todayVoteStatus.currentRewardCount || 0}}/5</text>
      </view>
      
      <view class="share-modal-buttons">
        <button class="share-btn-cancel" bindtap="cancelShare">å–æ¶ˆ</button>
        <button class="share-btn-confirm" bindtap="confirmShare">åˆ†äº«</button>
      </view>
    </view>
  </view>

  <!-- ç™»å½•æˆæƒå¼¹çª— -->
  <auth-dialog 
    wx:if="{{showAuthDialog}}"
    bind:loginsuccess="handleAuthSuccess"
    bind:logincancel="handleAuthCancel"
  ></auth-dialog>
</view>